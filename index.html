<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>循环计时器</title>
  <!-- PNG 优先：iOS 添加到主屏幕会优先用 180×180 的 icon.png -->
  <link rel="apple-touch-icon" sizes="180x180" href="icon.png" />
  <link rel="apple-touch-icon" href="icon.svg" />
  <style>
    :root {
      --bg: #fff;
      --text: #0a0a0a;
      --muted: #888;
      --line: #e5e5e5;
      --font: "Helvetica Neue", "SF Pro Text", -apple-system, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      font-weight: 300;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 48px 24px;
      -webkit-tap-highlight-color: transparent;
    }
    .header {
      width: 100%;
      max-width: 320px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 48px;
    }
    .header-title {
      font-size: 11px;
      font-weight: 400;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .btn-settings {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border: 1px solid var(--line);
      border-radius: 0;
      background: transparent;
      color: var(--text);
      text-decoration: none;
      cursor: pointer;
      transition: border-color 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-settings:hover, .btn-settings:active {
      border-color: var(--text);
    }
    .btn-settings svg {
      width: 16px;
      height: 16px;
    }
    .card {
      width: 100%;
      max-width: 320px;
      padding: 0;
      margin: auto 0;
    }
    .phase-label {
      font-size: 10px;
      font-weight: 400;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 16px;
    }
    .timer-display {
      font-variant-numeric: tabular-nums;
      font-size: 72px;
      font-weight: 200;
      line-height: 1;
      letter-spacing: -0.02em;
      margin-bottom: 32px;
      color: var(--text);
    }
    .progress-wrap {
      height: 1px;
      background: var(--line);
      overflow: hidden;
      margin-bottom: 32px;
    }
    .progress-bar {
      height: 100%;
      background: var(--text);
      transition: width 0.25s ease;
    }
    .cycle-info {
      font-size: 13px;
      font-weight: 300;
      color: var(--muted);
      margin-bottom: 40px;
    }
    .controls {
      display: flex;
      gap: 12px;
    }
    .btn {
      flex: 1;
      padding: 16px 24px;
      border: 1px solid var(--text);
      border-radius: 0;
      background: transparent;
      color: var(--text);
      font-family: var(--font);
      font-size: 12px;
      font-weight: 400;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .btn:active { opacity: 0.8; }
    .btn-primary {
      background: var(--text);
      color: var(--bg);
      border-color: var(--text);
    }
    .btn-secondary {
      background: transparent;
      color: var(--text);
    }
    .btn:disabled {
      border-color: var(--line);
      color: var(--muted);
      cursor: not-allowed;
      opacity: 1;
    }
    .btn-primary:disabled {
      background: var(--line);
      color: var(--muted);
    }
  </style>
</head>
<body id="body" class="phase-work">
  <header class="header">
    <span class="header-title">循环计时器</span>
    <a href="settings.html" class="btn-settings" title="设置">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <circle cx="12" cy="6" r="1.5"/>
        <circle cx="12" cy="12" r="1.5"/>
        <circle cx="12" cy="18" r="1.5"/>
      </svg>
    </a>
  </header>
  <div class="card">
    <div class="phase-label" id="phaseLabel">准备</div>
    <div class="timer-display" id="timerDisplay">--:--</div>
    <div class="progress-wrap">
      <div class="progress-bar" id="progressBar" style="width: 100%"></div>
    </div>
    <div class="cycle-info" id="cycleInfo">在设置中配置时间与循环</div>
    <div class="controls">
      <button type="button" class="btn btn-primary" id="btnStart">开始</button>
      <button type="button" class="btn btn-secondary" id="btnStop" disabled>暂停</button>
    </div>
  </div>

  <script>
    (function () {
      'use strict';

      const STORAGE_KEY = 'cycletimer_settings';

      /**
       * 从 localStorage 读取设置，无则返回默认值
       * @returns {{ workSec: number, restSec: number, cycles: number }}
       */
      function loadSettings() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const o = JSON.parse(raw);
            return {
              workSec: Math.max(1, Math.min(999, Number(o.workSec) || 30)),
              restSec: Math.max(0, Math.min(999, Number(o.restSec) ?? 20)),
              cycles: Math.max(1, Math.min(99, Number(o.cycles) || 5))
            };
          }
        } catch (e) { /* ignore */ }
        return { workSec: 30, restSec: 20, cycles: 5 };
      }

      const body = document.getElementById('body');
      const phaseLabel = document.getElementById('phaseLabel');
      const timerDisplay = document.getElementById('timerDisplay');
      const progressBar = document.getElementById('progressBar');
      const cycleInfo = document.getElementById('cycleInfo');
      const btnStart = document.getElementById('btnStart');
      const btnStop = document.getElementById('btnStop');

      const settings = loadSettings();
      let state = {
        running: false,
        cycleIndex: 0,
        totalCycles: settings.cycles,
        workSec: settings.workSec,
        restSec: settings.restSec,
        phase: 'work',
        remaining: 0,
        totalPhase: settings.workSec,
        tickId: null
      };

      function applyStoredSettings() {
        const s = loadSettings();
        state.workSec = s.workSec;
        state.restSec = s.restSec;
        state.totalCycles = s.cycles;
        if (!state.running) {
          state.totalPhase = state.workSec;
          render();
        }
      }

      function formatTime(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return m + ':' + (s < 10 ? '0' : '') + s;
      }

      function render() {
        if (!state.running && state.remaining === 0 && state.cycleIndex === 0) {
          timerDisplay.textContent = '--:--';
        } else {
          timerDisplay.textContent = formatTime(state.remaining);
        }
        const pct = (!state.running && state.remaining === 0 && state.cycleIndex === 0)
          ? 100
          : (state.totalPhase > 0 ? (state.remaining / state.totalPhase) * 100 : 0);
        progressBar.style.width = pct + '%';
        if (state.phase === 'work') {
          body.className = 'phase-work';
          phaseLabel.textContent = '进行中';
        } else {
          body.className = 'phase-rest';
          phaseLabel.textContent = '间隔休息';
        }
        if (state.running || state.remaining > 0) {
          cycleInfo.textContent = '第 ' + (state.cycleIndex + 1) + ' / ' + state.totalCycles + ' 轮';
        } else {
          cycleInfo.textContent = '在设置中配置时间与循环';
        }
      }

      function tick() {
        if (!state.running) return;
        state.remaining--;
        render();
        if (state.remaining <= 0) {
          if (state.phase === 'work') {
            state.phase = 'rest';
            state.remaining = state.restSec;
            state.totalPhase = state.restSec;
          } else {
            state.cycleIndex++;
            if (state.cycleIndex >= state.totalCycles) {
              stop();
              cycleInfo.textContent = '全部完成 · 共 ' + state.totalCycles + ' 轮';
              return;
            }
            state.phase = 'work';
            state.remaining = state.workSec;
            state.totalPhase = state.workSec;
          }
        }
        state.tickId = setTimeout(tick, 1000);
      }

      function start() {
        applyStoredSettings();
        state.cycleIndex = 0;
        state.phase = 'work';
        state.remaining = state.workSec;
        state.totalPhase = state.workSec;
        state.running = true;
        btnStart.disabled = true;
        btnStop.disabled = false;
        render();
        state.tickId = setTimeout(tick, 1000);
      }

      function stop() {
        state.running = false;
        if (state.tickId) clearTimeout(state.tickId);
        state.tickId = null;
        btnStart.disabled = false;
        btnStop.disabled = true;
        if (state.remaining <= 0 && state.cycleIndex >= state.totalCycles) {
          timerDisplay.textContent = '0:00';
          progressBar.style.width = '0%';
        }
        render();
      }

      btnStart.addEventListener('click', start);
      btnStop.addEventListener('click', stop);
      window.addEventListener('pageshow', applyStoredSettings);
      render();
    })();
  </script>
</body>
</html>
