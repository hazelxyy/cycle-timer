<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Cycle Timer" />
  <title>Cycle Timer</title>
  <link rel="apple-touch-icon" sizes="180x180" href="icon.png" />
  <link rel="apple-touch-icon" href="icon.svg" />
  <style>
    :root {
      --bg: #fff;
      --text: #0a0a0a;
      --muted: #888;
      --line: #e5e5e5;
      --font: "Helvetica Neue", "SF Pro Text", -apple-system, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      font-weight: 300;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 48px 24px;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    .header {
      width: 100%;
      max-width: 320px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 48px;
    }
    .header-title {
      font-size: 13px;
      font-weight: 400;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .header-right {
      position: relative;
      width: 56px;
      height: 44px;
      flex-shrink: 0;
    }
    .btn-settings, .btn-back {
      position: absolute;
      top: 0;
      right: 0;
      width: 56px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--line);
      border-radius: 0;
      background: transparent;
      color: var(--text);
      font-family: var(--font);
      font-size: 12px;
      font-weight: 400;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      text-decoration: none;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-back { padding: 0; }
    .header-right .view-hidden { opacity: 0; pointer-events: none; }
    .btn-settings:hover, .btn-back:hover { border-color: var(--text); }
    .btn-settings:active, .btn-back:active {
      border-color: var(--text);
      transform: scale(0.94);
    }
    .btn-settings svg { width: 16px; height: 16px; }
    .view-container {
      position: relative;
      flex: 1;
      width: 100%;
      max-width: 320px;
      min-height: 320px;
    }
    .view {
      width: 100%;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1), transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .view-hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(12px);
    }
    .card { padding: 0; }
    .phase-label {
      font-size: 11px;
      font-weight: 400;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 16px;
      transition: color 0.3s ease, opacity 0.3s ease;
    }
    .timer-screen {
      padding: 24px 20px;
      margin-bottom: 32px;
      position: relative;
    }
    .timer-display {
      font-variant-numeric: tabular-nums;
      font-family: "SF Mono", "Monaco", "Consolas", "Liberation Mono", monospace;
      font-size: 64px;
      font-weight: 300;
      line-height: 1.1;
      letter-spacing: 0.12em;
      color: var(--text);
      position: relative;
      transition: opacity 0.25s ease;
    }
    .timer-display .sep {
      letter-spacing: 0.08em;
      opacity: 0.7;
    }
    .progress-wrap {
      height: 1px;
      background: var(--line);
      overflow: hidden;
      margin-bottom: 32px;
    }
    .progress-bar {
      height: 100%;
      background: var(--text);
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .cycle-info {
      font-size: 15px;
      font-weight: 300;
      color: var(--muted);
      margin-bottom: 40px;
      transition: opacity 0.25s ease;
    }
    .controls { display: flex; gap: 12px; }
    .controls .btn { min-width: 0; }
    .btn {
      flex: 1;
      padding: 16px 24px;
      border: 1px solid var(--text);
      border-radius: 0;
      background: transparent;
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      font-weight: 400;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .btn:active {
      transform: scale(0.96);
    }
    .btn:disabled:active { transform: scale(1); }
    .btn-primary { background: var(--text); color: var(--bg); border-color: var(--text); }
    .btn-as-reset { background: transparent !important; border-color: var(--line) !important; color: var(--muted) !important; }
    .btn-as-reset:hover { border-color: var(--text); color: var(--text); }
    .btn-secondary { background: transparent; color: var(--text); }
    .btn:disabled {
      border-color: var(--line);
      color: var(--muted);
      cursor: not-allowed;
      opacity: 1;
    }
    .btn-primary:disabled { background: var(--line); color: var(--muted); }
    .btn-reset {
      width: 100%;
      margin-top: 16px;
      padding: 12px 24px;
      border: 1px solid var(--line);
      border-radius: 0;
      background: transparent;
      color: var(--muted);
      font-family: var(--font);
      font-size: 12px;
      font-weight: 400;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: border-color 0.2s ease, color 0.2s ease, transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .btn-reset:active { transform: scale(0.98); }
    .btn-reset:hover { border-color: var(--text); color: var(--text); }
    /* 设置面板 */
    .form-row {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px 0;
      border-bottom: 1px solid var(--line);
    }
    .form-row:last-of-type { border-bottom: none; }
    .form-row label {
      font-size: 14px;
      font-weight: 400;
      letter-spacing: 0.1em;
      color: var(--muted);
      min-width: 72px;
    }
    .form-row input[type="number"] {
      flex: 1;
      padding: 12px 0;
      border: none;
      border-bottom: 1px solid var(--line);
      background: transparent;
      color: var(--text);
      font-family: var(--font);
      font-size: 17px;
      font-weight: 300;
      transition: border-color 0.15s;
    }
    .form-row input[type="number"]:focus {
      outline: none;
      border-bottom-color: var(--text);
    }
    .form-row .unit { font-size: 14px; color: var(--muted); flex-shrink: 0; }
    .btn-save {
      width: 100%;
      margin-top: 48px;
      padding: 16px 24px;
      border: 1px solid var(--text);
      border-radius: 0;
      background: var(--text);
      color: var(--bg);
      font-family: var(--font);
      font-size: 14px;
      font-weight: 400;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .btn-save:active { transform: scale(0.96); }
  </style>
</head>
<body id="body" class="phase-work">
  <header class="header">
    <span class="header-title" id="headerTitle">循环计时器</span>
    <div class="header-right">
      <button type="button" class="btn-settings" id="btnSettings" title="设置">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="6" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="18" r="1.5"/>
        </svg>
      </button>
      <button type="button" class="btn-back view-hidden" id="btnBack">返回</button>
    </div>
  </header>

  <div class="view-container">
  <main class="view view-timer" id="viewTimer">
    <div class="card">
      <div class="phase-label" id="phaseLabel">准备</div>
      <div class="timer-screen">
        <div class="timer-display" id="timerDisplay">--:--</div>
      </div>
      <div class="progress-wrap">
        <div class="progress-bar" id="progressBar" style="width: 100%"></div>
      </div>
      <div class="cycle-info" id="cycleInfo">在设置中配置时间与循环</div>
      <div class="controls">
        <button type="button" class="btn btn-primary" id="btnStartPause">开始</button>
      </div>
      <button type="button" class="btn-reset" id="btnReset">复位</button>
    </div>
  </main>

  <main class="view view-hidden" id="viewSettings">
    <form id="form">
      <div class="form-row">
        <label for="workSec">每轮时间</label>
        <input type="number" id="workSec" inputmode="numeric" min="1" max="999" value="30" />
        <span class="unit">秒</span>
      </div>
      <div class="form-row">
        <label for="restSec">间隔时间</label>
        <input type="number" id="restSec" inputmode="numeric" min="0" max="999" value="20" />
        <span class="unit">秒</span>
      </div>
      <div class="form-row">
        <label for="cycles">循环次数</label>
        <input type="number" id="cycles" inputmode="numeric" min="1" max="99" value="5" />
      </div>
      <button type="submit" class="btn-save">保存并返回</button>
    </form>
  </main>
  </div>

  <script>
    (function () {
      'use strict';

      const STORAGE_KEY = 'cycletimer_settings';

      /** 振动：阶段结束短振，全部完成长振 */
      function vibrate(isAllDone) {
        if (typeof navigator.vibrate !== 'function') return;
        if (isAllDone) {
          navigator.vibrate([300, 150, 300]);
        } else {
          navigator.vibrate([200, 80, 200]);
        }
      }

      /** 声音：单次短音 @param {number} freq 频率 @param {number} duration 秒 @param {number} startTime 从当前起延迟秒数 */
      var audioCtx = null;
      function playTone(freq, duration, startTime) {
        startTime = startTime || 0;
        try {
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          if (audioCtx.state === 'suspended') audioCtx.resume();
          var t = audioCtx.currentTime + startTime;
          var osc = audioCtx.createOscillator();
          var gain = audioCtx.createGain();
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.setValueAtTime(0.15, t);
          gain.gain.exponentialRampToValueAtTime(0.01, t + duration);
          osc.start(t);
          osc.stop(t + duration);
        } catch (e) { /* 忽略 */ }
      }

      /** 每轮时间结束：滴滴答（两短一长/高） */
      function playWorkEndSound() {
        playTone(660, 0.1, 0);
        playTone(660, 0.1, 0.18);
        playTone(880, 0.16, 0.36);
      }

      /** 间隔时间结束：滴（一声） */
      function playRestEndSound() {
        playTone(660, 0.15, 0);
      }

      /** 全部完成：一声稍长 */
      function playAllDoneSound() {
        playTone(880, 0.35, 0);
      }

      /** 阶段结束时的提示（振动 + 声音） phase: 'work' | 'rest' | 'all' */
      function triggerPhaseEndFeedback(phase) {
        vibrate(phase === 'all');
        if (phase === 'work') playWorkEndSound();
        else if (phase === 'rest') playRestEndSound();
        else if (phase === 'all') playAllDoneSound();
      }

      function loadSettings() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const o = JSON.parse(raw);
            return {
              workSec: Math.max(1, Math.min(999, Number(o.workSec) || 30)),
              restSec: Math.max(0, Math.min(999, Number(o.restSec) ?? 20)),
              cycles: Math.max(1, Math.min(99, Number(o.cycles) || 5))
            };
          }
        } catch (e) { /* ignore */ }
        return { workSec: 30, restSec: 20, cycles: 5 };
      }

      const body = document.getElementById('body');
      const phaseLabel = document.getElementById('phaseLabel');
      const timerDisplay = document.getElementById('timerDisplay');
      const progressBar = document.getElementById('progressBar');
      const cycleInfo = document.getElementById('cycleInfo');
      const btnStartPause = document.getElementById('btnStartPause');
      const btnReset = document.getElementById('btnReset');
      const viewTimer = document.getElementById('viewTimer');
      const viewSettings = document.getElementById('viewSettings');
      const btnSettings = document.getElementById('btnSettings');
      const btnBack = document.getElementById('btnBack');
      const headerTitle = document.getElementById('headerTitle');
      const form = document.getElementById('form');

      const settings = loadSettings();
      let state = {
        running: false,
        cycleIndex: 0,
        totalCycles: settings.cycles,
        workSec: settings.workSec,
        restSec: settings.restSec,
        phase: 'work',
        remaining: 0,
        totalPhase: settings.workSec,
        tickId: null
      };

      function showTimer() {
        viewTimer.classList.remove('view-hidden');
        viewSettings.classList.add('view-hidden');
        btnSettings.classList.remove('view-hidden');
        btnBack.classList.add('view-hidden');
        headerTitle.textContent = '循环计时器';
      }

      function showSettings() {
        viewTimer.classList.add('view-hidden');
        viewSettings.classList.remove('view-hidden');
        btnSettings.classList.add('view-hidden');
        btnBack.classList.remove('view-hidden');
        headerTitle.textContent = '设置';
        loadIntoForm();
      }

      function loadIntoForm() {
        var s = loadSettings();
        document.getElementById('workSec').value = s.workSec;
        document.getElementById('restSec').value = s.restSec;
        document.getElementById('cycles').value = s.cycles;
      }

      function getFormValues() {
        var work = parseInt(document.getElementById('workSec').value, 10);
        var rest = parseInt(document.getElementById('restSec').value, 10);
        var cycles = parseInt(document.getElementById('cycles').value, 10);
        if (isNaN(work) || work < 1 || work > 999) return null;
        if (isNaN(rest) || rest < 0 || rest > 999) return null;
        if (isNaN(cycles) || cycles < 1 || cycles > 99) return null;
        return { workSec: work, restSec: rest, cycles: cycles };
      }

      btnSettings.addEventListener('click', showSettings);
      btnBack.addEventListener('click', showTimer);

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var values = getFormValues();
        if (!values) {
          alert('请填写有效数值：每轮时间 1–999 秒，间隔 0–999 秒，循环 1–99 次。');
          return;
        }
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(values));
        } catch (err) {
          alert('保存失败，请重试。');
          return;
        }
        state.workSec = values.workSec;
        state.restSec = values.restSec;
        state.totalCycles = values.cycles;
        if (!state.running) {
          state.totalPhase = state.workSec;
          render();
        }
        showTimer();
      });

      function applyStoredSettings() {
        var s = loadSettings();
        state.workSec = s.workSec;
        state.restSec = s.restSec;
        state.totalCycles = s.cycles;
        if (!state.running) {
          state.totalPhase = state.workSec;
          render();
        }
      }

      /** 格式化为 MM:SS，冒号用 span 以便样式区分 */
      function formatTime(sec) {
        var m = Math.floor(sec / 60);
        var s = sec % 60;
        var ss = (s < 10 ? '0' : '') + s;
        return m + '<span class="sep">:</span>' + ss;
      }

      function render() {
        if (!state.running && state.remaining === 0 && state.cycleIndex === 0) {
          timerDisplay.innerHTML = '--<span class="sep">:</span>--';
        } else {
          timerDisplay.innerHTML = formatTime(state.remaining);
        }
        var pct = (!state.running && state.remaining === 0 && state.cycleIndex === 0)
          ? 100
          : (state.totalPhase > 0 ? (state.remaining / state.totalPhase) * 100 : 0);
        progressBar.style.width = pct + '%';
        if (state.phase === 'work') {
          body.className = 'phase-work';
          phaseLabel.textContent = '进行中';
        } else {
          body.className = 'phase-rest';
          phaseLabel.textContent = '间隔休息';
        }
        if (state.running || state.remaining > 0) {
          cycleInfo.textContent = '第 ' + (state.cycleIndex + 1) + ' / ' + state.totalCycles + ' 轮';
        } else {
          cycleInfo.textContent = '在设置中配置时间与循环';
        }
      }

      function tick() {
        if (!state.running) return;
        state.remaining--;
        render();
        if (state.remaining <= 0) {
          if (state.phase === 'work') {
            triggerPhaseEndFeedback('work');
            state.phase = 'rest';
            state.remaining = state.restSec;
            state.totalPhase = state.restSec;
          } else {
            state.cycleIndex++;
            if (state.cycleIndex >= state.totalCycles) {
              triggerPhaseEndFeedback('all');
              stop();
              cycleInfo.textContent = '全部完成 · 共 ' + state.totalCycles + ' 轮';
              return;
            }
            triggerPhaseEndFeedback('rest');
            state.phase = 'work';
            state.remaining = state.workSec;
            state.totalPhase = state.workSec;
          }
        }
        state.tickId = setTimeout(tick, 1000);
      }

      function start() {
        applyStoredSettings();
        if (!audioCtx) {
          try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
          } catch (e) { /* 忽略 */ }
        }
        state.cycleIndex = 0;
        state.phase = 'work';
        state.remaining = state.workSec;
        state.totalPhase = state.workSec;
        state.running = true;
        btnStartPause.textContent = '暂停';
        btnStartPause.classList.add('btn-as-reset');
        btnStartPause.classList.remove('btn-primary');
        render();
        state.tickId = setTimeout(tick, 1000);
      }

      function stop() {
        state.running = false;
        if (state.tickId) clearTimeout(state.tickId);
        state.tickId = null;
        btnStartPause.textContent = '开始';
        btnStartPause.classList.remove('btn-as-reset');
        btnStartPause.classList.add('btn-primary');
        if (state.remaining <= 0 && state.cycleIndex >= state.totalCycles) {
          timerDisplay.innerHTML = '0<span class="sep">:</span>00';
          progressBar.style.width = '0%';
        }
        render();
      }

      /** 复位：停止计时并恢复到初始状态，可重新开始 */
      function reset() {
        stop();
        applyStoredSettings();
        state.cycleIndex = 0;
        state.remaining = 0;
        state.phase = 'work';
        state.totalPhase = state.workSec;
        render();
      }

      btnStartPause.addEventListener('click', function () {
        if (state.running) stop(); else start();
      });
      btnReset.addEventListener('click', reset);
      window.addEventListener('pageshow', applyStoredSettings);
      render();
    })();
  </script>
</body>
</html>
